<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>Testing Services Workers</title>
</head>

<body>

    <div style='max-width: 700px; margin: 0 auto 0 auto;'>
        <button id='swinstall'>Install Service Worker</button>
        <button id='swuninstall'>Uninstall Service Worker</button>
        <div id='js-log' style='height: 400px; overflow: scroll; color: white; background: black; font-family: monospace; line-height: 150%; font-size: 12px; padding: 7px;'></div>
        <a href='http://mattandre.ws'>mattandre.ws</a> <a href='http://twitter.com/andrewsmatt'>@andrewsmatt</a>
    </div>
  
    <script src='//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
    <script>

        (function() {

        var log = function() {
            // console.log.apply(console, arguments);
            var $el = $('<div/>');
            $el.html(Array.prototype.join.call(arguments, '<br />'));
            $('#js-log').append($el);
        };
        
        window.onerror = function(err) {
            log('Error', err);
        };

        window.addEventListener('message', function(event) {
            console.log('message from window', event);
            //debugger;
        });

        if (window.MessageChannel) {
            var messageChannel = new MessageChannel();
            messageChannel.port1.onmessage = function(event) {
                log('message from channel', event);
            };
        }

        // setTimeout(function() { // Wait 5s and send message
        //     window.dispatchEvent(new Event('message', {testing: 'Test message'}));
        //     console.log('Event message triggered');
        // }, 5000);


        if (!('serviceWorker' in navigator)) {
            log('Browser does not support Service Worker, are you using Chrome Canary? Is the Service Worker flag switched on? chrome://flags/#enable-service-worker');
            return;
        }

        log('Browser supports Service Worker');
        console.log('navigator.serviceWorker ok');

        if (navigator.serviceWorker.controller) {
            log('Current Service Worker state: '+navigator.serviceWorker.controller.state);
            log('Go to chrome://serviceworker-internals/ or chrome://inspect/#service-workers');
        }
        else {
            log('No Service Worker active...');
        }

        if (Notification && Notification.permission !== 'granted') Notification.requestPermission();

        $('#swinstall').on('click', function() {

            log('About to try to install a Service Worker');

            navigator.serviceWorker.ready.then(function(serviceWorkerRegistration) {
                console.log('navigator.serviceWorker.ready', serviceWorkerRegistration); // .pushManager

                serviceWorkerRegistration.addEventListener('statechange', function(event) {
                    console.log('event statechange()', event);
                });

                serviceWorkerRegistration.addEventListener('message', function(event) {
                        console.log('event message()', event);
                        log('Worker state is now ', event.target.state);
                });

            });

            navigator.serviceWorker
                .register('https://molokoloco.github.io/tests/worker.js', {
                    scope: '/tests/'
                })
                .then(function(myWorker) {
                    console.log('myWorker', myWorker);
                    log('Successfully installed ServiceWorker');

                    myWorker.addEventListener('statechange', function(event) {
                        console.log('event', event);
                        log('Worker state is now ', event.target.state);
                    });

                    if (messageChannel && myWorker.postMessage) {
                        console.log('messageChannel', messageChannel);
                        myWorker.postMessage({
                            text: 'Hi  world!',
                            port: messageChannel && messageChannel.port2
                        }, [messageChannel && messageChannel.port2]);
                    }

                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                    log('ServiceWorker registration failed: ', err);
                });

        });

        $('#swuninstall').on('click', function() {
            log('About to try to uninstall a Service Worker');

            if (!navigator.serviceWorkercontroller) return; // .current ?

            navigator.serviceWorker
                .unregister()
                .then(function() {
                    log('Successfully uninstalled ServiceWorker');
                }, function(why) {
                    console.log(why)
                    log('Failed to uninstall ' + why);
                });

        });


        /*
            // http://w3c.github.io/push-api/
            // https://example.com/serviceworker.js

            this.onpush = function(event) {
              console.log(event.data);
              // From here we can write the data to IndexedDB, send it to any open windows,
              // display a notification, etc.
            }

            // https://example.com/webapp.js
            navigator.serviceWorker.ready.then(function(serviceWorkerRegistration) {
              serviceWorkerRegistration.pushManager.register().then(
                function(pushRegistration) {
                  console.log(pushRegistration.registrationId);
                  console.log(pushRegistration.endpoint);
                  // The push registration details needed by the application server to push
                  // messages to the push service are now available, and can be sent to the
                  // application server using, for example, an XMLHttpRequest.
                }, function(error) {
                  // During development it often helps to log errors to the console. In a
                  // production environment it might make sense to also report information
                  // about errors back to the application server.
                  console.log(error);
                }
              );
            });
        */

    }());

    </script>
</body>
</html>