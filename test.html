<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Testing Services Workers</title>
</head>

<body>

    <div style="max-width: 700px; margin: 0 auto 0 auto;">
        <button id="swinstall">Install Service Worker</button>
        <button id="swuninstall">Uninstall Service Worker</button>
        <div id="js-log" style="height: 400px; overflow: scroll; color: white; background: black; font-family: monospace; line-height: 150%; font-size: 12px; padding: 7px;"></div>
        <a href="http://mattandre.ws">mattandre.ws</a> <a href="http://twitter.com/andrewsmatt">@andrewsmatt</a>
    </div>
  
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script>

        (function() {

        var log = function() {
            var $el = $('<div/>');
            $el.html(Array.prototype.join.call(arguments, '<br />'));
            $('#js-log').append($el);
        };
        
        window.onerror = function(err) {
            log("Error", err);
        };

        window.addEventListener('message', function(event) {
            console.log('message', event);
            notifyMe();
            //debugger;
        });

        var messageChannel = null;

        if (window.MessageChannel) {
            messageChannel = new MessageChannel();
            messageChannel.port1.onmessage = function(event) {
                log("Got reply from serviceworker via channel", event.data);
            };
        }

        var notifyMe = function() {
            if (!Notification) {
                log('Notification : Please us a modern version of Chrome, Firefox, Opera or Firefox.');
                return;
            }

            if (Notification.permission !== "granted") Notification.requestPermission();

            var notification = new Notification('Notification title', {
                icon: 'http://cdn.sstatic.net/stackexchange/img/logos/so/so-icon.png',
                body: "Hey there! You've been notified from PAGE!",
            });

            notification.onclick = function () {
                window.open("http://stackoverflow.com/a/13328397/1269037");
            }
        };

        setTimeout(function() { // Wait 5s and send message

            window.dispatchEvent(new Event('message', {testing: 'Test message'}));
            console.log('Event message triggered');

        }, 5000);



        if (!('serviceWorker' in navigator)) {
            log("Browser does not support Service Worker, are you using Chrome Canary? Is the Service Worker flag switched on? chrome://flags/#enable-service-worker");
            return;
        }

        log("Browser supports Service Worker");

        console.log('navigator.serviceWorker', navigator.serviceWorker, navigator.serviceWorker.state);

        if (navigator.serviceWorker.state == 'activated') {
            log("Current Service Worker state: \\o/");
            log('Go to chrome://serviceworker-internals/ or chrome://inspect/#service-workers');
        }
        else {
            log("No Service Worker active...");
        }

        $('#swinstall').on('click', function() {

            log('About to try to install a Service Worker');

            navigator.serviceWorker.ready.then(function(serviceWorkerRegistration) {
                console.log('navigator.serviceWorker.ready', serviceWorkerRegistration); // .pushManager
            });

            navigator.serviceWorker
                .register('https://molokoloco.github.io/tests/worker.js', {
                    scope: '/tests/'
                })
                .then(function(myWorker) {

                    console.log('myWorker', myWorker);

                    log('Successfully installed ServiceWorker');
                    log('Go to chrome://serviceworker-internals/ or chrome://inspect/#service-workers');

                    myWorker.addEventListener('statechange', function(event) {
                        console.log('event', event);
                        log("Worker state is now ", event.target.state);
                    });

                    if (messageChannel) {
                        console.log('messageChannel', messageChannel);
                        myWorker.postMessage({
                            text: "Hi  world!",
                            port: messageChannel && messageChannel.port2
                        }, [messageChannel && messageChannel.port2]);
                    }

                }, function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                    log('ServiceWorker registration failed: ', err);
                });

        });

        $('#swuninstall').on('click', function() {
            log('About to try to uninstall a Service Worker');

            if (!navigator.serviceWorker.current) return;

            navigator.serviceWorker
                .unregister()
                .then(function() {
                    log('Successfully uninstalled ServiceWorker');
                }, function(why) {
                    console.log(why)
                    log('Failed to uninstall ' + why);
                });

        });

    }());

    </script>
</body>
</html>