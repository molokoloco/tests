<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Testing Services Workers</title>
    <style type="text/css">
    html, body {
        background: lightgrey;
        text-align: center;
    }
    * {
        font: 12px Arial;
        color: grey;
    }
    h1 {
        font-size: 24px;
        font-weight: bold;
    }
    #console {
        max-width: 700px;
        margin: 40px auto 0 auto;
    }
    #js-log {
        height: 280px;
        overflow: scroll;
        background: black;
        padding: 10px;
    }
    #js-log div {
        font-family: monospace;
        color: yellow;
        line-height: 150%;
        font-size: 12px;
        text-align: left;
    }
    </style>
</head>

<body>

    <div id="console">
        <h1>Service Worker Test</h1>
        <div id="js-log"></div><br />
        <!--//<button id="swinstall">Install Service Worker</button>//--><button id="swuninstall">Uninstall Service Worker</button><br />
        <br />
        URL to send messages : <a href="http://www.bytel.tv/notifs/poll.php?message=HERE%20THE%20MESSAGE" target="_blank">http://www.bytel.tv/notifs/poll.php?message=HERE%20THE%20MESSAGE</a>
    </div>
  
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <!-- <script src="./worker.js"></script> -->
    <script>

    (function() {

        // ------------------------ Messaging ------------------------ //

        var log = function() {
            var $el = $('<div/>').html(Array.prototype.join.call(arguments, '<br />'));
            $('#js-log').append($el);
        };
        
        window.onerror = function(err) {
            log('Error!', err);
        };

        // ------------------------ Service Worker INSTALL ------------------------ //

        var installWorker = function() {
            log('About to try to install a Service Worker');
            console.log('installing Service Worker');

            navigator.serviceWorker
                .register('https://molokoloco.github.io/tests/worker.js', { // INSTALL !!!
                    scope: '/tests/'
                })
                .then(function(myWorker) {
                    console.log('myWorker', myWorker);
                    log('Successfully installed ServiceWorker');
                    window.location.reload(); // to use it now !
                }, function(err) {
                    console.log('ServiceWorker registration failed(1): ', err);
                    log('ServiceWorker registration failed: ', err);
                })
                .catch(function(err) {
                    console.log('ServiceWorker registration failed(2): ', err);
                    log('ServiceWorker registration failed: ', err);
                });
        };

        var uninstallWorker = function() {
            log('About to try to uninstall a Service Worker');
            console.log('uninstalling Service Worker...');

            if (navigator.serviceWorkercontroller) {
                navigator.serviceWorker
                    .unregister()
                    .then(function() {
                        log('Successfully uninstalled ServiceWorker');
                    }, function(err) {
                        console.log(err);
                        log('Failed to uninstall: ' + err);
                    });
            }
        };

        // ------------------------ Service Worker detect ------------------------ //

        if (!('serviceWorker' in navigator)) {
            log('Browser does not support Service Worker, are you using Chrome Canary? Is the Service Worker flag switched on? chrome://flags/#enable-service-worker');
            return;
        }

        log('Browser supports Service Worker');
        console.log('navigator.serviceWorker ok');

        if (navigator.serviceWorker.controller) {
            log('Current Service Worker state: '+navigator.serviceWorker.controller.state);
            log('Go to chrome://serviceworker-internals/ or chrome://inspect/#service-workers');
        }
        else {
            log('No Service Worker active...');
            setTimeout(installWorker, 2000); // Auto-install worker
        }

        // ------------------------ Notification detect ------------------------ //

        if (!('Notification' in window)) {
            log('Browser does not support Notification...');
            return;
        }

        log('Browser supports Notification');
        console.log('window.Notification ok');

        if (Notification.permission !== 'granted') Notification.requestPermission();

        // ------------------------ Service Worker EVENTS ------------------------ //

        navigator.serviceWorker.ready.then(function(myWorker) {
            console.log('navigator.serviceWorker.ready', myWorker); // .pushManager

            myWorker.addEventListener('statechange', function(event) {
                console.log('event', event);
                log('Worker state is now ', event.target.state);
            });

            myWorker.addEventListener('message', function(event) {
                console.log('event message()', event);
                log('Worker state is now ', event.target.state);
            });

            if (messageChannel && myWorker.postMessage) {
                console.log('messageChannel', messageChannel);
                myWorker.postMessage({
                    text: 'Hi  world!',
                    port: messageChannel && messageChannel.port2
                }, [messageChannel && messageChannel.port2]);
            }

            /*
            myWorker.pushManager.register().then(
                function(pushRegistration) {
                  console.log(pushRegistration.registrationId);
                  console.log(pushRegistration.endpoint);
                  // The push registration details needed by the application server to push
                  // messages to the push service are now available, and can be sent to the
                  // application server using, for example, an XMLHttpRequest.
                }, function(error) {
                  // During development it often helps to log errors to the console. In a
                  // production environment it might make sense to also report information
                  // about errors back to the application server.
                  console.log(error);
                }
              );
            */
        });
        
        // ------------------------ Service Worker UI ------------------------ //

        $('#swinstall').on('click', installWorker);
        $('#swuninstall').on('click', uninstallWorker);

        // ------------------------ Window messaging ------------------------ //

        window.addEventListener('message', function(event) {
            console.log('message from window', event);
        });

        if ('MessageChannel' in window) {
            var messageChannel = new MessageChannel();
            
            messageChannel.port1.onmessage = function(event) {
                console.log('messageChannel 1', event.data);
            };
            messageChannel.port2.onmessage = function(event) {
                console.log('messageChannel 2', event.data);
            };
            messageChannel.port1.start();
            
            setTimeout(function() {
                messageChannel.port1.postMessage('Hello from page !');
            }, 5000);
        }

        // setTimeout(function() { // Wait 5s and send message
        //     window.dispatchEvent(new Event('message', {testing: 'Test message'}));
        //     console.log('Event message triggered');
        // }, 5000);

    }());
    </script>
</body>
</html>